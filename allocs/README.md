## Allocs

These scripts are utilities for setting up the `genesis.json` file for a new chain. 

Developers write Forge script(s) that deploy and configure the contracts they wish to be pre-deployed on their chain. These scripts can then produce an `alloc` JSON file to input to `genesis.json`, which will setup those contracts with the correct code and storage slots.

## Usage

###  Dependencies

Install `heimdall` - instructions [here](https://github.com/Jon-Becker/heimdall-rs/tree/main?tab=readme-ov-file#installation--usage)

Install `foundry` - instructions [here](https://book.getfoundry.sh/getting-started/installation)

### Setup Scripts

First, the developer must setup their `deploy-scripts.json` with the Forge scripts they want to run.

Each script is represented in JSON with the following fields:
- `relativePath`: the relative path to the repo containing the Forge script to run.
- `deployFile`: the file name that contains the Forge script.
- `deployContract`: the name of the contract in which the script is defined.
- `deploySignature`: the function signature of the deploy script

Using Uniswap's [Permit2](https://github.com/Uniswap/permit2/blob/main/script/DeployPermit2.s.sol) as an example, the JSON would look like this:
```
    {
        "relativePath": "../permit2",
        "deployFile": "DeployPermit2.s.sol",
        "deployContract": "DeployPermit2",
        "deploySignature": "run"
    }
```

### Deploy

This bash script will run each of the deploy scripts within their respective repos, then output the addresses of every contract deployed:

```shell
$ ./allocs/deploy.sh $RPC_URL $PRIVATE_KEY
```

### Generate Alloc

This script will read from the outputs generated by the deploy script, then use `cast code` and `heimdall dump` to generate a complete `alloc` JSON:

```shell
$ ./allocs/generate-alloc.sh $ARCHIVE_RPC_URL
```

NOTE: You MUST provide an archive RPC endpoint that supports `trace_replayBlockTransactions`, as `heimdall dump` relies on this endpoint. Unfortuntately, at the time of writing, `anvil` does not support this endpoint.

### Check Alloc

If you have an `alloc` JSON and you wish to check the storage slots against a deployed chain, you can run the following script: 
```shell
$ ./allocs/check-alloc.sh $RPC_URL
```
Note that a non-archive RPC endpoint is fine for this command.